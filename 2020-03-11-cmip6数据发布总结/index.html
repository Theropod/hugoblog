<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>CMIP6数据发布步骤总结 | WGS84教信者</title>
        <meta name="Description" content="WGS84教信者"><meta property="og:title" content="CMIP6数据发布步骤总结" />
<meta property="og:description" content="1. 在control machine上安装ansible 2. 在manage machine克隆esgf-ansible的目录 3. 两个配置文件 sampl" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.theropod.tk/2020-03-11-cmip6%E6%95%B0%E6%8D%AE%E5%8F%91%E5%B8%83%E6%80%BB%E7%BB%93/" />
<meta property="article:published_time" content="2020-03-11T18:47:08+08:00" />
<meta property="article:modified_time" content="2020-03-11T18:47:08+08:00" /><meta property="og:site_name" content="WGS84教信者" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="CMIP6数据发布步骤总结"/>
<meta name="twitter:description" content="1. 在control machine上安装ansible 2. 在manage machine克隆esgf-ansible的目录 3. 两个配置文件 sampl"/>
<meta name="theme-color" content="#ffffff">
<meta name="msapplication-TileColor" content="#da532c">
<link rel="canonical" href="https://blog.theropod.tk/2020-03-11-cmip6%E6%95%B0%E6%8D%AE%E5%8F%91%E5%B8%83%E6%80%BB%E7%BB%93/" />
<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="prev" href="https://blog.theropod.tk/2019-12-09-%E6%9C%8D%E5%8A%A1%E5%99%A8ssh%E8%BD%AC%E5%8F%91%E4%B8%8D%E5%A5%BD%E4%BD%BF%E4%B9%8B%E8%A7%A3%E5%86%B3/" /><link rel="next" href="https://blog.theropod.tk/2020-11-14-%E6%9C%89%E5%85%B3linux%E5%88%A0%E9%99%A4libc.so.6%E4%B9%8B%E5%90%8E%E7%9A%84%E5%87%A0%E7%A7%8D%E5%8F%AF%E8%83%BD%E8%A1%A5%E6%95%91/" /><link rel="stylesheet" href="/lib/fontawesome-free/all.min.9a680b90260b5106d79f4075491ab31daafa7429eff686453c40b58357309649.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk="><link rel="stylesheet" href="/lib/animate/animate.min.3c770e90f98eb21b0c042fafb49755af93306fbaf42e449524f94fae9fc83295.css" integrity="sha256-PHcOkPmOshsMBC&#43;vtJdVr5Mwb7r0LkSVJPlPrp/IMpU="><link rel="stylesheet" href="/css/style.min.b499aa36490cd3731b618b943112e5024effc494a3522ab3309e40e6afacbc1e.css" integrity="sha256-tJmqNkkM03MbYYuUMRLlAk7/xJSjUiqzMJ5A5q&#43;svB4=">
<script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "CMIP6数据发布步骤总结",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/blog.theropod.tk\/2020-03-11-cmip6%E6%95%B0%E6%8D%AE%E5%8F%91%E5%B8%83%E6%80%BB%E7%BB%93\/"
        },"image": {
                "@type": "ImageObject",
                "url": "https:\/\/blog.theropod.tk\/images\/me\/avatar.png",
                "width":  867 ,
                "height":  868 
            },"genre": "posts","keywords": "毕业用","wordcount":  5282 ,
        "url": "https:\/\/blog.theropod.tk\/2020-03-11-cmip6%E6%95%B0%E6%8D%AE%E5%8F%91%E5%B8%83%E6%80%BB%E7%BB%93\/","datePublished": "2020-03-11T18:47:08\x2b08:00","dateModified": "2020-03-11T18:47:08\x2b08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
                "@type": "Organization",
                "name": "Theropod",
                "logo": {
                "@type": "ImageObject",
                "url": "https:\/\/blog.theropod.tk\/images\/me\/avatar.png",
                "width":  867 ,
                "height":  868 
                }
            },"description": ""
    }
    </script></head>
    <body><script>
            if (!window.localStorage || !window.localStorage.getItem('theme')) {window.isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;} else {
                window.isDark = (window.localStorage && window.localStorage.getItem('theme')) === 'dark';
            }
            window.isDark && document.body.classList.add('dark-theme');
        </script><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title animated bounceIn">
            <a href="/">WGS84教信者</a>
        </div>
        <div class="menu"><a class="menu-item"
                href="/posts/" >Posts</a><a class="menu-item"
                href="/tags/" >Tags</a><a class="menu-item"
                href="/categories/" >Categories</a><a href="javascript:void(0);" class="theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-rotate-180 fa-fw"></i>
            </a>
        </div>
    </div>
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-136276173-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

    
</header><header class="mobile" id="header-mobile">
    <div class="header-wrapper">
        <div class="header-container">
            <div class="header-title animated bounceIn">
                <a href="/">WGS84教信者</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">Posts</a><a class="menu-item" href="/tags/" title="">Tags</a><a class="menu-item" href="/categories/" title="">Categories</a><a href="javascript:void(0);" class="theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-rotate-180 fa-fw"></i>
            </a>
        </div>
    </div>
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-136276173-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

    
</header>

<script>
    window.desktopHeaderMode = "auto";
    window.mobileHeaderMode = "auto";
</script><main class="main">
                <div class="container"><article class="page single"><h1 class="single-title animated flipInX">CMIP6数据发布步骤总结</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author">
                    <a class="author" href="https://blog.theropod.tk" rel="author" target="_blank">
                        <i class="fas fa-user-circle fa-fw"></i>WGS84教信者
                    </a>
                </span>&nbsp;<span class="post-category">included in&nbsp;
                            <span>
                                <a href="/categories/%E6%93%8D%E4%BD%9C%E7%BB%8F%E9%AA%8C">
                                    <i class="far fa-folder fa-fw"></i>操作经验
                                </a>
                            </span></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i><time datetime=2020-03-11>2020-03-11</time>&nbsp;
                <i class="fas fa-pencil-alt fa-fw"></i>about 5282 words&nbsp;
                <i class="far fa-clock fa-fw"></i>11 min&nbsp;</div>
        </div><div class="toc" id="toc-auto">
                <h2 class="toc-title">Contents</h2>
                <div class="toc-content" id="toc-content-auto"></div>
            </div>
            <div class="toc" id="toc-static">
                <details>
                    <summary>
                        <div class="toc-title">
                            <span>Contents</span>
                            <span><i class="details icon fas fa-angle-down"></i></span>
                        </div>
                    </summary>
                    <div class="toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#1-在control-machine上安装ansible">1. 在control machine上安装ansible</a></li>
    <li><a href="#2-在manage-machine克隆esgf-ansible的目录">2. 在manage machine克隆esgf-ansible的目录</a></li>
    <li><a href="#3-两个配置文件">3. 两个配置文件</a>
      <ul>
        <li><a href="#samplehosts是描述远程机器的模板这里配置为data-only">sample.hosts是描述远程机器的模板，这里配置为data only</a></li>
        <li><a href="#host_varsmyhostmyorgyml是安装配置文件名要和hosts里的名称一致">host_vars/myhost.my.org.yml是安装配置，文件名要和hosts里的名称一致</a></li>
      </ul>
    </li>
    <li><a href="#4-在target-machine上面使用playbook部署">4. 在target machine上面使用Playbook部署</a>
      <ul>
        <li><a href="#命令">命令</a></li>
        <li><a href="#曾遇到的问题">曾遇到的问题</a></li>
      </ul>
    </li>
    <li><a href="#5-部署完成后首次配置发布数据">5. 部署完成后首次配置发布数据</a>
      <ul>
        <li><a href="#附加的功能">附加的功能</a></li>
        <li><a href="#准备esgprep">准备，esgprep</a></li>
        <li><a href="#发布-esgpublish同样的conda环境--注意publish和unpublishmapfile一定要保存好">发布 esgpublish，同样的conda环境  注意publish和unpublish，mapfile一定要保存好</a></li>
        <li><a href="#几点实践经验">几点实践经验</a></li>
      </ul>
    </li>
    <li><a href="#6数据更新追加撤回实践">6.数据更新、追加、撤回实践</a>
      <ul>
        <li><a href="#根据要求每次更新或撤回错误数据都要先在errata上说明原因附上影响的文件列表作为长期记录">根据要求，每次更新或撤回错误数据都要先在ERRATA上说明原因，附上影响的文件列表，作为长期记录。</a></li>
        <li><a href="#撤回">撤回</a></li>
        <li><a href="#更新或追加">更新或追加</a></li>
      </ul>
    </li>
    <li><a href="#作为警醒的一个事件曾经删除了etc下所有文件">作为警醒的一个事件：曾经删除了/etc下所有文件</a>
      <ul>
        <li><a href="#背景">背景</a></li>
        <li><a href="#五个why">五个why</a></li>
        <li><a href="#改进">改进</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
                </details>
            </div><div class="content" id="content"><h2 id="1-在control-machine上安装ansible">1. 在control machine上安装ansible</h2>
<h2 id="2-在manage-machine克隆esgf-ansible的目录">2. 在manage machine克隆esgf-ansible的目录</h2>
<h2 id="3-两个配置文件">3. 两个配置文件</h2>
<h3 id="samplehosts是描述远程机器的模板这里配置为data-only">sample.hosts是描述远程机器的模板，这里配置为data only</h3>
<ul>
<li>需要有一个domain name (fully qulified domain name)
<ul>
<li>在清华经过国际处和网络中心的诸多手续才能申请，而且他们得先看到网站本体才能给你通过。</li>
<li>临时没有domain name可以指定ip和端口号替代</li>
</ul>
</li>
</ul>
<h3 id="host_varsmyhostmyorgyml是安装配置文件名要和hosts里的名称一致">host_vars/myhost.my.org.yml是安装配置，文件名要和hosts里的名称一致</h3>
<ul>
<li>github里有配置为data node的示例
<ul>
<li>关于https证书部分
<ul>
<li>清华是自动在校园网的出口配置https，所以设置generate_httpd:true来生成个假的就行，别人访问就是https</li>
<li>如果不像清华这种自动配置的，就按照自己的域名用LetsEncrypt设置</li>
</ul>
</li>
<li>有关Globus的证书
<ul>
<li>称为Globus services Certificate，用于服务器向Globus来注册自己的GridFTP/Myproxy服务。安装时首先配置generate_globus为true，在root用户目录下产生CSR，将CSR邮件给ESGF相应管理员获得证书，之后可以用local_certs.yml安装证书，或重新安装时在globus设置里配置此证书的路径，不再generate_globus。</li>
<li>注意，清华节点开放端口申请复杂，所以没有安装GridFTP，而data node不需要MyProxy服务，因此本步骤只是为了防止在esg-publish和unpublish的时候可能会弹出认证。</li>
<li>Globus 用户名密码部分
<ul>
<li>需要申请一个globus帐户密码然后填上去，否则不给通过安装</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="4-在target-machine上面使用playbook部署">4. 在target machine上面使用Playbook部署</h2>
<h3 id="命令">命令</h3>
<ul>
<li>用户有root权限<code>ansible-playbook -v -i hosts.test --ask-pass -u hxm_stu --ask-become-pass --tags data --limit sample.host install.yml</code></li>
<li>root用户<code>ansible-playbook -v -i hosts.test --ask-pass -u root --tags data --limit sample.host install.yml</code></li>
</ul>
<h3 id="曾遇到的问题">曾遇到的问题</h3>
<ul>
<li>在wsl里会说权限是777的话config就忽略了，改下文件夹的权限</li>
<li>selinux 会说没有安装libpython-selinux但是已经安了？关闭目标机上的selinux</li>
<li>安装中failed to open file 等问题？先把playbook上的步骤看懂然后在目标机器上手动运行，再重试</li>
<li>下载migation script失败？经常出现下载github repo资源时超时的情况，只能重试</li>
<li>出现 Import Web CA Into Trust Store这一步找不到文件？但是文件都在?
<ul>
<li>手动在certs.yml里定义executable的位置</li>
</ul>
</li>
<li>java 的openjdk 装完之后在/etc/profile里定义,但是安装里还是非要说我没装，只好把java的role改了</li>
<li>yum 使用清华源</li>
<li>/etc/globus-connect-server-esgf.conf hostcert.pem hostkey.pem不存在 需要看playbook脚本内容，手动自己装上。（但因为清华没用GridFTP其实不影响，可以注掉）</li>
<li>测试安装
<ul>
<li>
<p><code>ansible-playbook -v -i hosts.test --ask-pass -u root --tags data --limit sample.host start.yml status.yml</code></p>
</li>
<li>
<p>Unable to start service httpd: Job for httpd.service failed because the control process exited with error code. See &ldquo;systemctl status httpd.service&rdquo; and &ldquo;journalctl -xe&rdquo; for details</p>
<p>在目标机上启动httpd失败，错误是Syntax error on line 24 of /etc/httpd/conf/httpd.ssl.conf: SSLCertificateChainFile: file &lsquo;/etc/certs/cachain.pem&rsquo; does not exist or is empty. 但是清华是自动的https，已经不需要这个了，注释掉就可。</p>
</li>
<li>
<p>服务器重启 注意默认的catalog需要apache 和 tomcat都起来</p>
</li>
</ul>
</li>
</ul>
<h2 id="5-部署完成后首次配置发布数据">5. 部署完成后首次配置发布数据</h2>
<ul>
<li>官方提示：不要用root来发布，尽量建立一个新的账号和用户组</li>
</ul>
<h3 id="附加的功能">附加的功能</h3>
<ul>
<li>cdf2cim
<ul>
<li>CIM2 (Common Information Model 2)， 希望直接从netcdf的global attributes中提取出来这一信息，作为json放在指定目录，之后上传到ES-DOC网站里面</li>
<li>esg-publisher里已经安装了这个模块，cmip6的话自动调用和扫描</li>
<li>需要管理员在github群组里注册自己的id，然后下载access token</li>
<li>失败了也不影响esg-publisher的其他步骤</li>
</ul>
</li>
<li>Citation信息需要联系WIP，来首先注册机构和数据
<ul>
<li><a href="https://github.com/WCRP-CMIP/CMIP6_CVs">https://github.com/WCRP-CMIP/CMIP6_CVs</a></li>
<li><a href="http://cmip6cite.wdc-climate.de/#Information-for-ESGF-Data-Node-Managers">http://cmip6cite.wdc-climate.de/#Information-for-ESGF-Data-Node-Managers</a></li>
</ul>
</li>
<li>有关Thredds和root url网页
<ul>
<li>thredds里面有关标题、图片、联系方式、组织等信息在/esg/下面设置</li>
<li>域名的根页面原来是空的，现在在/etc/httpd/htdocs下放了一个html作为首页。放的是如何撤回、更新、追加的信息。</li>
</ul>
</li>
</ul>
<h3 id="准备esgprep">准备，esgprep</h3>
<ul>
<li>软件安装
<ul>
<li><strong>用到conda 比如在/usr/local/conda/bin ansible安装会给一个esg-pub环境，esgprep这些组件都已经有了</strong></li>
<li>需要hdf5 yum包名其实是hdf5-devel</li>
<li>python2.6安装语法不兼容，只能改系统默认python</li>
</ul>
</li>
<li>数据生产步骤 (github上也有)
<ol>
<li>fetch esgf configuration ini files: <code>esgfetchini</code></li>
<li>fetch cmor tables: <code>esgfetchtables</code>，用来自动PrePARE</li>
</ol>
<ul>
<li>如果文件不是cmor生成：
如果文件里没有cmorized,publish入库的一步会自动检查是否符合cmip6 cmor tables， 有三个配置选项在esg.ini定义https://esgf.github.io/esg-publisher/configuration.html。esgfetchtables的tables要对应文件里cmor版本，默认下载在usr/local。有时这个目录不能访问，而且按照cmor版本fetch branch也会报错，上述选项不太好使，就直接手动PrePARE了。esg.ini加上skip_validation=True（老版本安装的src/python/esgcet/esgcet/config/cmip6_handler.py没有这个选项，手动更新了一下文件）</li>
<li>手动PrePARE：
<code>PrePARE -l ./PrePARE_log/ice --table-path ./cmip6-cmor-tables-6.7.31/Tables/ ../ice</code></li>
</ul>
<ol start="3">
<li>DRS （Data Reference Syntax）把结果文件按DRS的格式组织（变量路径中加入version等）可以管理数据版本，生成文件的时候会进行一些检查
<ul>
<li>初次扫描 <code>esgdrs list --project cmip6 /mypath/ciesm_data/copy3</code>会把结果写进临时的文件</li>
<li>可以预览drs tree 和构建目录结构的语句(todo和tree)。觉得可以了就<code>esgdrs upgrade --project cmip6 /mypath/ciesm_data/copy1 --link</code> 这里会默认在当前目录下创建DRS树，比如选择<code>/esg/data</code>注意默认是直接移动文件，文档里推荐使用&ndash;link但若不在同一个物理存储，所以只能用symlink,而symlink会出错。所以尽量同一个存储</li>
</ul>
</li>
<li>在DRS基础上生成mapfile
<ul>
<li>
<p>检查路径<code>esgmapfile show --project cmip6 --directory /mypath/ciesm_data/ocn --outdir /mypath/ciesm_data/esg/mapfiles/ocn/</code></p>
</li>
<li>
<p>生成<code>esgmapfile make --project cmip6 /mypath/ciesm_data/ocn --outdir /mypath/ciesm_data/esg/mapfiles/ocn/</code></p>
</li>
<li>
<p>例子</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="o">(</span>esgdrs list --project cmip6 /mypath/ciesm_data/ice <span class="p">|</span> tee ../../DRS_log/ice-list.txt<span class="o">)</span> <span class="o">&amp;&amp;</span>
<span class="o">(</span>esgdrs tree --project cmip6 /mypath/ciesm_data/ice <span class="p">|</span> tee ../../DRS_log/ice-tree.txt<span class="o">)</span> <span class="o">&amp;&amp;</span>
<span class="o">(</span>esgdrs upgrade --project cmip6 /mypath/ciesm_data/ice --link <span class="p">|</span> tee ../../DRS_log/ice-upgrade.txt<span class="o">)</span> <span class="o">&amp;&amp;</span>
<span class="o">(</span>esgmapfile make --project cmip6 /mypath/ciesm_data/esg/DRS/ice --outdir /mypath/ciesm_data/esg/mapfiles/ice/<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>esgdrs upgrade 是在执行命令的目录下面生成DRS文件目录结构</p>
</li>
<li>
<p>esgdrs的结果临时文件pkl file放在/tmp</p>
</li>
<li>
<p>esgdrs upgrade生成的新目录里version是扫描的日期，会去掉错误的文件,在这个基础上生成的mapfile的版本也是扫描的日期。</p>
</li>
<li>
<p>不论是否事先esgdrs，esgmapfile若使用原本文件的目录，生成的mapfile的version日期是文件目录里version，且不会略过错误的文件。（比如ice数据部分prc_Amon_CIESM_ssp245_r1i1p1f1_grrABnJE22594.nc在mapfile里没有忽略，若publish到database在解析attributes里时index out of range）</p>
</li>
</ul>
</li>
</ol>
</li>
</ul>
<h3 id="发布-esgpublish同样的conda环境--注意publish和unpublishmapfile一定要保存好">发布 esgpublish，同样的conda环境  注意publish和unpublish，mapfile一定要保存好</h3>
<ol>
<li>
<p>Generate certificate for publication with myproxy-logon 用的普通用户来发布 <code>myproxy-logon -b -s esgf-node.llnl.gov -l username -p 7512 -t 72 -o $HOME/.globus/certificate-file</code></p>
</li>
<li>
<p>publish</p>
<p>三步: database, thredds server, index node</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">1. esgpublish --project cmip6 --map ./mapfiles <span class="o">[</span>--set-replica<span class="o">]</span>
2. esgpublish --project cmip6 --map ./mapfiles --service fileservice --noscan --thredds <span class="o">[</span>--set-replica<span class="o">]</span>
3. esgpublish --project cmip6 --map ./mapfiles --noscan --publish <span class="o">[</span>--set-replica<span class="o">]</span>
</code></pre></td></tr></table>
</div>
</div><p>或者<code>esgpublish --project cmip6 --map ./mapfiles --service fileservice --noscan --thredds --publish</code>
(不推荐,容易出错)publish to postgres, Thredds and the Index in one step</p>
</li>
<li>
<p>unpublish</p>
<ul>
<li>删除全部,网络原因API可能会失效，多来几遍才能全删<code>esgunpublish --project cmip6 --map ./mapfiles --database-delete --delete</code></li>
<li>thredds在tomcat，重启tomcat后可以看到本地的都被删了</li>
<li>若unpublish不能删除网站上的东西的话，可以直接使用unpublish api来删除</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">wget --no-check-certificate --ca-certificate <span class="nv">$HOME</span>/.globus/certificate-file
--certificate <span class="nv">$HOME</span>/.globus/certificate-file
--private-key <span class="nv">$HOME</span>/.globus/certificate-file --verbose -O response.xml
--post-data<span class="o">=</span><span class="s2">&#34;id=CMIP6.CMIP.THU.CIESM.historical.r1i1p1f1.Amon.clivi.gr.v20191202|cmip.dess.tsinghua.edu.cn&#34;</span>
https://esgf-node.llnl.gov/esg-search/ws/delete
</code></pre></td></tr></table>
</div>
</div><p>注意，官方会提到有test publish的地址，但是实际邮件沟通是不能用的，耽误了很久。。。要发布的话应当直接发布</p>
</li>
</ol>
<h3 id="几点实践经验">几点实践经验</h3>
<ol>
<li>有关两次检查
手动运行PrePARE检查，然后DRS生成的时候也会检查。如果文件不是cmor生成，在publish时跳过自动的PrePARE。</li>
<li>有关数据目录
由于学校给出的模式结果是按atm/lnd/ocn这样分组的，我产生的DRS目录和mapfiles目录都是按/atm/lnd/ocn分别存放。这样发布和撤回时也是分开的，便于找错。</li>
<li>有关更新或者增加文件
数据原始目录里复制替换nc文件，然后重新运行一遍DRS和mapfile，照常发布即可。</li>
</ol>
<h2 id="6数据更新追加撤回实践">6.数据更新、追加、撤回实践</h2>
<h3 id="根据要求每次更新或撤回错误数据都要先在errata上说明原因附上影响的文件列表作为长期记录">根据要求，每次更新或撤回错误数据都要先在ERRATA上说明原因，附上影响的文件列表，作为长期记录。</h3>
<p><a href="https://errata.es-doc.org/static/index.html">https://errata.es-doc.org/static/index.html</a></p>
<h3 id="撤回">撤回</h3>
<ul>
<li>
<p>使用unpublish的delete（不要用retract，否则再次向thredds server发布新版本数据出现operation not supported at this point），可以不删除本地数据库。</p>
<p><code>esgunpublish --project cmip6 --map ./mapfiles --delete</code></p>
</li>
<li>
<p>将撤回的部分专门放在mapfiles的子目录中保留一段时间，以便检查和重新发布等</p>
</li>
</ul>
<h3 id="更新或追加">更新或追加</h3>
<ul>
<li>首先撤回错误的</li>
<li>对需追加的新文件PrePARE查错， esgdrs list tree upgrade，在drs目录里生成新版本的文件。同时，log保存在DRS_log</li>
<li>espmapfile来生成新版本的mapfile</li>
<li>对新的mapfile来esgpublish</li>
</ul>
<h2 id="作为警醒的一个事件曾经删除了etc下所有文件">作为警醒的一个事件：曾经删除了/etc下所有文件</h2>
<h3 id="背景">背景</h3>
<ul>
<li>
<p><strong>周二下午-晚上</strong>
一直运行esgtest_publish测试发布，出现失败。找到<a href="https://github.com/ESGF/esg-publisher/blob/master/src/python/esgcet/esgcet/publish/thredds.py%E5%8F%91%E7%8E%B0%E6%98%AF%E5%9B%A0%E4%B8%BA%E8%AE%BF%E9%97%AEreiniturl%EF%BC%88https://localhost/thredds/admin/debug?Catalogs/recheck%EF%BC%89%E5%A4%B1%E8%B4%A5%EF%BC%8C%EF%BC%88SSL:">https://github.com/ESGF/esg-publisher/blob/master/src/python/esgcet/esgcet/publish/thredds.py发现是因为访问reiniturl（https://localhost/thredds/admin/debug?Catalogs/recheck）失败，（SSL:</a> SSLV3_ALERT_HANDSHAKE_FAILURE）从而没有得到正确返回。</p>
</li>
<li>
<p><strong>周三早上</strong>
更改esg.ini中的此url设置为http，无效。想到可以直接更改验证条件，但查看thredds文档后认为tomcat服务器8443使用的self-signed web certificate是过去生成的，而服务器修改过fqdn，判断可能需要重新生成，而不是更改thredds.py的验证条件，以避免潜在 的更多问题。</p>
</li>
<li>
<p><strong>周三下午</strong>
删除tomcat设置路径中的cert,尝试使用esgf-ansible安装步骤来重新生成它们。遇到找不到证书而globus-connect-server程序初始化失败，导致安装失败的问题。直接在目标机运行globus-connect-server，同样找不到对应证书文件而失败。查看globus文档后，尝试根据升级指导删除旧的配置文件（由esgf-ansible生成），再重新由esgf-ansible安装和进行globus-connect-server初始化配置。需要删除：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">sudo rm /etc/globus-connect-server.conf
sudo rm -r /etc/grid-security
sudo rm -r /var/lib/globus-connect-server
sudo rm /etc/gridftp.conf
</code></pre></td></tr></table>
</div>
</div><p>删除时使用root，第一次打字错误，因此第二次自动补全，其后输入空格直接执行类似<code>rm /etc/grid * -rf</code>。约5秒后尝试删除globus-connect-server.conf时发现未找到文件，意识到/etc已经全部被删除。考虑到若没有unmount所在硬盘，执行恢复操作也会造成写入，因此未进行任何操作，联系管理员。</p>
</li>
</ul>
<h3 id="五个why">五个why</h3>
<ul>
<li>问题：/etc被删除，236集群设置损坏，无法登录和使用</li>
</ul>
<ol>
<li>为什么/etc被删除？ -因为使用root执行<code>rm /etc/grid * -rf</code>，意外删除整个目录。</li>
<li>为什么要删除/etc下的内容？ -为了解决esgtest_publish的访问证书出错问题，决定重新配置globus，因此递归删除/etc/globus-connect-server.conf等目录和文件</li>
<li>为什么要使用root？ -在paratera用户下曾经尝试使用esg-pub的环境进行数据发布各项准备，但是出现报错而root没有，尝试解决此问题一段时间无果，就直接使用了root。同时esgf-ansible创建的各目录和配置是root，出于经常配置的惰性也直接使用了root。</li>
<li>为什么执行-rf没有检查？或采取更安全的方法？ -因为急于解决esgtest_publish问题，经过连续的调试后产生了投机的心理，注意力下降，忽视了基本安全操作。</li>
<li>为什么要手动操作解决重新安装问题，而不是使用脚本？ - 本来使用ansible定义脚本来操作可以避免问题，但安装使用过程中经常出现失败，需要调整236服务器的依赖等，最终感到脚本更适合全新服务器安装，不愿再花时间使用脚本</li>
</ol>
<h3 id="改进">改进</h3>
<ol>
<li>改变操作时的习惯，检查或是不使用危险的命令，尤其在不同压力或是状态时能够牢记这些</li>
<li>不把希望寄托在人不犯错上，如尽量使用脚本，以及在本机器esgf部署这种复杂的情况里，花时间整理修改权限等问题，尽量使得运行调试权限不和其他各种文件产生干扰</li>
</ol>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>The article was updated on 2020-03-11</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="https://blog.theropod.tk/2020-03-11-cmip6%E6%95%B0%E6%8D%AE%E5%8F%91%E5%B8%83%E6%80%BB%E7%BB%93/index.md" target="_blank">Read Markdown</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="https://blog.theropod.tk/2020-03-11-cmip6%E6%95%B0%E6%8D%AE%E5%8F%91%E5%B8%83%E6%80%BB%E7%BB%93/" data-title="CMIP6数据发布步骤总结" data-hashtags="毕业用"><i class="fab fa-twitter fa-fw"></i>
</a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="https://blog.theropod.tk/2020-03-11-cmip6%E6%95%B0%E6%8D%AE%E5%8F%91%E5%B8%83%E6%80%BB%E7%BB%93/" data-hashtag="毕业用"><i class="fab fa-facebook-square fa-fw"></i>
</a><a href="javascript:void(0);" title="Share on Linkedin" data-sharer="linkedin" data-url="https://blog.theropod.tk/2020-03-11-cmip6%E6%95%B0%E6%8D%AE%E5%8F%91%E5%B8%83%E6%80%BB%E7%BB%93/"><i class="fab fa-linkedin fa-fw"></i>
</a><a href="javascript:void(0);" title="Share on WhatsApp" data-sharer="whatsapp" data-url="https://blog.theropod.tk/2020-03-11-cmip6%E6%95%B0%E6%8D%AE%E5%8F%91%E5%B8%83%E6%80%BB%E7%BB%93/" data-title="CMIP6数据发布步骤总结" data-web><i class="fab fa-whatsapp fa-fw"></i>
</a><a href="javascript:void(0);" title="Share on Pinterest" data-sharer="pinterest" data-url="https://blog.theropod.tk/2020-03-11-cmip6%E6%95%B0%E6%8D%AE%E5%8F%91%E5%B8%83%E6%80%BB%E7%BB%93/"><i class="fab fa-pinterest fa-fw"></i>
</a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section><span>
                        <a href="/tags/%E6%AF%95%E4%B8%9A%E7%94%A8">
                            <i class="fas fa-tag fa-fw"></i>毕业用
                        </a>
                    </span>&nbsp;</section>
        <section>
            <span><a href="javascript:window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="https://blog.theropod.tk/2019-12-09-%E6%9C%8D%E5%8A%A1%E5%99%A8ssh%E8%BD%AC%E5%8F%91%E4%B8%8D%E5%A5%BD%E4%BD%BF%E4%B9%8B%E8%A7%A3%E5%86%B3/" class="prev" rel="prev" title="服务器/VSCode ssh转发各种不好使解决"><i class="fas fa-angle-left fa-fw"></i>服务器/VSCode ssh转发各种不好使解决</a>
            <a href="https://blog.theropod.tk/2020-11-14-%E6%9C%89%E5%85%B3linux%E5%88%A0%E9%99%A4libc.so.6%E4%B9%8B%E5%90%8E%E7%9A%84%E5%87%A0%E7%A7%8D%E5%8F%AF%E8%83%BD%E8%A1%A5%E6%95%91/" class="next" rel="next" title="有关Linux删除libc.so.6之后的几种可能补救">有关Linux删除libc.so.6之后的几种可能补救<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div class="comment"><div id="disqus_thread"></div><noscript>
            Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript></div>
    </article></div>
            </main><footer class="footer">
    <div class="copyright"><div class="copyright-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreffer">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="external nofollow noopener noreffer">LoveIt<i class="far fa-heart fa-fw"></i></a>
        </div>

        <div class="copyright-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2019 - 2020</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://blog.theropod.tk" target="_blank">WGS84教信者</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
    </div>
</footer>
</div><a href="#" class="dynamic-to-top animated faster" id="dynamic-to-top">
            <span>&nbsp;</span>
        </a><script src="https://theropodblog.disqus.com/embed.js"></script><script src="/lib/smooth-scroll/smooth-scroll.polyfills.min.54590077ee163035c3dd38dc034e9f6915ecbe680dd832f449afa21672cab116.js" integrity="sha256-VFkAd&#43;4WMDXD3TjcA06faRXsvmgN2DL0Sa&#43;iFnLKsRY="></script><script src="/lib/sharer/sharer.min.9c88f86c7f0820287113f6236200459832693656e80d7556cc80a93dfbd45813.js" integrity="sha256-nIj4bH8IIChxE/YjYgBFmDJpNlboDXVWzICpPfvUWBM="></script><script src="/js/theme.min.1482fc67bfa2c3b8cebe476d0037b9321b5b7a8a1525b547b94143948be90e9e.js" integrity="sha256-FIL8Z7&#43;iw7jOvkdtADe5MhtbeooVJbVHuUFDlIvpDp4="></script>
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-136276173-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
</body>
</html>
