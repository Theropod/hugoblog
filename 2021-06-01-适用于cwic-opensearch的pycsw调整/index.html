<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>CWIC-Beijing服务器软件安装与操作记录 - WGS84教信者</title><meta name="description" content="WGS84教信者"><meta property="og:title" content="CWIC-Beijing服务器软件安装与操作记录" />
<meta property="og:description" content="背景 需要为CWIC的Opensearch系统提供数据，并使其最终能在NASA Earth Data Search上找到。对于CEOS，以NRSCC节点的名义来发" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://theropod.github.io/hugoblog/2021-06-01-%E9%80%82%E7%94%A8%E4%BA%8Ecwic-opensearch%E7%9A%84pycsw%E8%B0%83%E6%95%B4/" /><meta property="og:image" content="https://theropod.github.io/logo.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-06-21T17:54:31+08:00" />
<meta property="article:modified_time" content="2021-06-21T17:54:31+08:00" /><meta property="og:site_name" content="WGS84教信者" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://theropod.github.io/logo.png"/>

<meta name="twitter:title" content="CWIC-Beijing服务器软件安装与操作记录"/>
<meta name="twitter:description" content="背景 需要为CWIC的Opensearch系统提供数据，并使其最终能在NASA Earth Data Search上找到。对于CEOS，以NRSCC节点的名义来发"/>
<meta name="application-name" content="WGS84教信者">
<meta name="apple-mobile-web-app-title" content="WGS84教信者"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://theropod.github.io/hugoblog/2021-06-01-%E9%80%82%E7%94%A8%E4%BA%8Ecwic-opensearch%E7%9A%84pycsw%E8%B0%83%E6%95%B4/" /><link rel="prev" href="https://theropod.github.io/hugoblog/2021-01-30-%E4%BF%9D%E6%8C%81%E5%AE%9E%E9%AA%8C%E5%AE%A4%E7%BD%91%E7%BB%9C%E8%BF%9E%E6%8E%A5%E5%88%B0%E6%B8%85%E5%8D%8E%E7%BD%91/" /><link rel="next" href="https://theropod.github.io/hugoblog/2021-06-21-fork%E4%B9%8B%E5%90%8E%E8%AE%BE%E7%BD%AEupstream%E5%92%8Corigin%E8%AE%B0%E5%BD%95%E4%BF%AE%E6%94%B9merge%E4%B8%BB%E4%BB%93%E5%BA%93%E5%8F%98%E5%8C%96/" /><link rel="stylesheet" href="/hugoblog/lib/normalize/normalize.min.055364f5be272caa092b0e6654c165828707f8ab971e2656383a6d6392bc345e.css" integrity="sha256-BVNk9b4nLKoJKw5mVMFlgocH&#43;KuXHiZWODptY5K8NF4="><link rel="stylesheet" href="/hugoblog/css/style.min.623091c4f3b927646c79b3db3772f496ee423628b9567bc0c74af55a4d50d1ba.css" integrity="sha256-YjCRxPO5J2RsebPbN3L0lu5CNii5VnvAx0r1Wk1Q0bo="><link rel="stylesheet" href="/hugoblog/lib/fontawesome-free/all.min.876d023d9d10c97941b80c3b03e2a5b94631ff7a4af9cee5604a6a2d39718d84.css" integrity="sha256-h20CPZ0QyXlBuAw7A&#43;KluUYx/3pK&#43;c7lYEpqLTlxjYQ="><link rel="stylesheet" href="/hugoblog/lib/animate/animate.min.3c770e90f98eb21b0c042fafb49755af93306fbaf42e449524f94fae9fc83295.css" integrity="sha256-PHcOkPmOshsMBC&#43;vtJdVr5Mwb7r0LkSVJPlPrp/IMpU="><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "CWIC-Beijing服务器软件安装与操作记录",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/theropod.github.io\/hugoblog\/2021-06-01-%E9%80%82%E7%94%A8%E4%BA%8Ecwic-opensearch%E7%9A%84pycsw%E8%B0%83%E6%95%B4\/"
        },"genre": "posts","keywords": "毕业用","wordcount":  5520 ,
        "url": "https:\/\/theropod.github.io\/hugoblog\/2021-06-01-%E9%80%82%E7%94%A8%E4%BA%8Ecwic-opensearch%E7%9A%84pycsw%E8%B0%83%E6%95%B4\/","datePublished": "2021-06-21T17:54:31+08:00","dateModified": "2021-06-21T17:54:31+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "WGS84教信者"},"author": {
                "@type": "Person",
                "name": "WGS84教信者"
            },"description": ""
    }
    </script></head>
    <body header-desktop="auto" header-mobile="auto"><script type="text/javascript">('' === 'true' && window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('dark' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'dark' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/hugoblog/" title="WGS84教信者">WGS84教信者</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/hugoblog/hugoblog/posts/"> Posts </a><a class="menu-item" href="/hugoblog/hugoblog/tags/"> Tags </a><a class="menu-item" href="/hugoblog/hugoblog/categories/"> Categories </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/hugoblog/" title="WGS84教信者">WGS84教信者</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/hugoblog/hugoblog/posts/" title="">Posts</a><a class="menu-item" href="/hugoblog/hugoblog/tags/" title="">Tags</a><a class="menu-item" href="/hugoblog/hugoblog/categories/" title="">Categories</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">CWIC-Beijing服务器软件安装与操作记录</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://blog.theropod.tk" title="Author" target="_blank" rel="noopener noreferrer author" class="author"><i class="fas fa-user-circle fa-fw"></i>WGS84教信者</a></span>&nbsp;<span class="post-category">included in <a href="/hugoblog/categories/web%E7%9B%B8%E5%85%B3/"><i class="far fa-folder fa-fw"></i>WEB相关</a>&nbsp;<a href="/hugoblog/categories/gis/"><i class="far fa-folder fa-fw"></i>GIS</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2021-06-21">2021-06-21</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;5520 words&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;12 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#背景">背景</a></li>
    <li><a href="#文件和存储位置">文件和存储位置</a>
      <ul>
        <li><a href="#glass数据">GLASS数据</a></li>
        <li><a href="#张衡数据">张衡数据</a></li>
        <li><a href="#其他文件">其他文件</a></li>
      </ul>
    </li>
    <li><a href="#opensearch和pycsw软件操作">Opensearch和Pycsw软件操作</a>
      <ul>
        <li><a href="#安装">安装</a></li>
        <li><a href="#标准和数据">标准和数据</a></li>
        <li><a href="#数据入库">数据入库</a></li>
        <li><a href="#osdd准备">OSDD准备</a></li>
        <li><a href="#运行">运行</a></li>
        <li><a href="#pycsw输出opensearch结果的流程">pycsw输出opensearch结果的流程</a></li>
        <li><a href="#对pycsw的修改">对pycsw的修改</a></li>
        <li><a href="#如何查询">如何查询</a></li>
        <li><a href="#程序管理">程序管理</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="背景">背景</h2>
<p>需要为CWIC的Opensearch系统提供数据，并使其最终能在NASA Earth Data Search上找到。对于CEOS，以NRSCC节点的名义来发布GLASSGLASS数据。目前已经把目录中的名称在IDN网站上注册</p>
<hr>
<h2 id="文件和存储位置">文件和存储位置</h2>
<h3 id="glass数据">GLASS数据</h3>
<ol>
<li>BNU这次新送来的硬盘里，有新产生的XML文件和图象文件</li>
<li>同时XML文件已经在/root/glass-xml, 有Albedo、BBE、DSR、ET、FAPAR、FV、GPP、LAI、PAR九个文件夹</li>
</ol>
<ul>
<li>修改后向CWIC注册的GLASS数据集：24个
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">NRSCC_GLASS_Albedo_AVHRR_0.05D
NRSCC_GLASS_Albedo_MODIS_0.05D
NRSCC_GLASS_Albedo_MODIS_1KM
NRSCC_GLASS_BBE_AVHRR_0.05D
NRSCC_GLASS_BBE_MODIS_0.05D
NRSCC_GLASS_BBE_MODIS_1KM
NRSCC_GLASS_ET_AVHRR_0.05D
NRSCC_GLASS_ET_MODIS_0.05D
NRSCC_GLASS_ET_MODIS_1KM
NRSCC_GLASS_FAPAR_AVHRR_0.05D
NRSCC_GLASS_FAPAR_MODIS_0.05D
NRSCC_GLASS_FAPAR_MODIS_1KM
NRSCC_GLASS_FVC_AVHRR_0.05D
NRSCC_GLASS_FVC_MODIS_500M
NRSCC_GLASS_FVC_MODIS_0.05D
NRSCC_GLASS_GPP_AVHRR_0.05D
NRSCC_GLASS_GPP_MODIS_500M
NRSCC_GLASS_GPP_AVHRR_0.05D_YEARLY
NRSCC_GLASS_GPP_MODIS_500M_YEARLY
NRSCC_GLASS_LAI_AVHRR_0.05D
NRSCC_GLASS_LAI_MODIS_0.05D
NRSCC_GLASS_LAI_MODIS_1KM
NRSCC_GLASS_DSR_MODIS_0.05D
NRSCC_GLASS_PAR_MODIS_0.05D
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h3 id="张衡数据">张衡数据</h3>
<ul>
<li>数据<br>
原始的放在/data/upload
解压后和生成xml的脚本放在/data/for_download</li>
<li>数据下载配置<br>
安装了httpd让人下载数据<br>
配置根据https://www.digitalocean.com/community/tutorials/how-to-install-the-apache-web-server-on-centos-8<br>
数据（通过软链接）和log放在/var/www/CSES/<br>
配置文件在/etc/httpd/sites-available和/etc/httpd/sites-enabled</li>
</ul>
<h3 id="其他文件">其他文件</h3>
<ul>
<li>Onenote有张衡数据的一些说明</li>
<li>本地有张衡数据的文件说明、GLASS和张衡数据Collection列表、访问测试结果</li>
<li>本地备份了服务器上用的一些脚本</li>
<li>Github里有pycsw的版本，服务器上用的一些脚本</li>
</ul>
<h2 id="opensearch和pycsw软件操作">Opensearch和Pycsw软件操作</h2>
<h3 id="安装">安装</h3>
<ul>
<li>/root/pycsw下从git安装了pycsw
<ul>
<li>用稳定版，目前是2.6.0 尝试过几次开发中的版本都有返回结果出错的问题</li>
<li>安装方式是官网上的deploy in 4 minutes</li>
<li>以screen运行了pycsw的http服务</li>
</ul>
</li>
<li>安装了一个httpd，用来让别人访问我的OSDD
<ul>
<li>pycsw站点的设置文件在/etc/httpd/sites-available和sites-enabled</li>
<li>OSDD 放在/var/www/pycsw</li>
</ul>
</li>
</ul>
<h3 id="标准和数据">标准和数据</h3>
<ul>
<li>ceos有opensearch best practice的文档，但没有pycsw的教程。为了将数据集发布到NASA里面并可以搜索到，数据集级别的搜索需要在注册页面提供OSDD文档url，能够选择collection和通过kvp来时空搜索</li>
<li>数据已经被转成了ISO19115 xml格式</li>
<li>坐标问题：pycsw需要XML有ReferenceSystemInfo这一项，若缺失就都填入CARTESIAN，否则无法通过pycsw。DSR和PAR数据集有此问题。</li>
<li>需要修改元数据XML中的ParentIdentifier作为数据集名称</li>
<li>具体的执行脚本在/root/glass-xml/prepare_xml.sh</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 示例命令</span>
find . -type f -exec sed -i <span class="s1">&#39;63s#&lt;gco:CharacterString&gt;&lt;/gco:CharacterString&gt;#&lt;gco:CharacterString&gt;CARTESIAN&lt;/gco:CharacterString&gt;#g&#39;</span> <span class="o">{}</span> <span class="se">\;</span>
find . -type f -name <span class="s2">&#34;*AVHRR*&#34;</span> -exec sed -i <span class="s1">&#39;13i \  \&lt;gmd:parentIdentifier&gt;\n    &lt;gco:CharacterString&gt;NRSCC_GLASS_Albedo_AVHRR_0.05D&lt;/gco:CharacterString&gt;\n  &lt;/gmd:parentIdentifier&gt;&#39;</span> <span class="o">{}</span> <span class="se">\;</span>
<span class="c1"># find condition -exec COMMANDS {} \; 是一个固定用法，find的结果被放在{}里面一个个执行，-exec和\;之间的东西是commands)</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="数据入库">数据入库</h3>
<ul>
<li>更换数据库为postgis，原来是sqlite，性能低</li>
<li>postgis安装初始化教程
<a href="https://people.planetpostgresql.org/devrim/index.php?/archives/107-Installing-PostGIS-3.1-and-PostgreSQL-13-on-CentOS-8.html" target="_blank" rel="noopener noreferrer">https://people.planetpostgresql.org/devrim/index.php?/archives/107-Installing-PostGIS-3.1-and-PostgreSQL-13-on-CentOS-8.html</a>
<a href="https://computingforgeeks.com/how-to-install-postgis-on-centos-8-linux/" target="_blank" rel="noopener noreferrer">https://computingforgeeks.com/how-to-install-postgis-on-centos-8-linux/</a><br>
查看安装状态<code>systemctl status postgresql-13</code></li>
<li>现在的安装</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 安装后设置username和passwd，填给pycsw的default.cfg</span>
pip install psycopg2-binary <span class="c1">#安装postgis</span>
create database pycsw, table records, pycsw-admin.py -c setup_db -f default.cfg <span class="c1"># 准备好pycsw使用的数据库</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>导入时提示<code>SAWarning: Did not recognize type 'geometry' of column 'wkb_geometry'</code>但据这个说不影响。https://gitter.im/geopython/pycsw?at=5f96914a270d004bcfef308d</li>
<li>所有的入库命令在文件存储位置和Github处有备份</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 示例命令</span>
<span class="nb">cd</span> /root/pycsw
. bin/activate
<span class="nb">cd</span> /root/pycsw/pycsw
pycsw-admin.py -c load_records -f default.cfg -p /root/glass-xml/Albedo
<span class="c1"># 这个命令不会Recursively导入数据</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="osdd准备">OSDD准备</h3>
<ul>
<li>要把OSDD(OpenSearch Descriptor Document)放在/var/www/pycsw/glass/osdd，用apache服务出去，它描述了本机所有数据集的opensearch地址。</li>
<li>OSDD修改自pycsw默认的OSDD，做了模板文件和生成osdd的脚本，放在/var/www/pycsw和Github</li>
</ul>
<h3 id="运行">运行</h3>
<h4 id="使用httpd来发布osdd文件">使用httpd来发布osdd文件</h4>
<ul>
<li>安装httpd，把osdd的xml放入/var/www/pycsw/glass/osdd
<a href="https://www.digitalocean.com/community/tutorials/how-to-install-the-apache-web-server-on-centos-8" target="_blank" rel="noopener noreferrer">https://www.digitalocean.com/community/tutorials/how-to-install-the-apache-web-server-on-centos-8</a><br>
地址如<code>http://47.90.244.40/glass/osdd/par.xml</code></li>
</ul>
<h4 id="httpd的配置">httpd的配置</h4>
<ul>
<li>NASA解析要求我们不要出现端口号，同时在看log时发现对httpd和本地的pycsw都有很多无关请求。因此
服务器关闭了所有非httpd的端口，把不并使用Virtualhost proxypass来转发pycsw的本地端口到/csw，用rewriteCond把所有不想要的请求都返回404。同时设置了log</li>
<li>pycsw.conf配置文件</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">LoadModule rewrite_module modules/mod_rewrite.so
&lt;VirtualHost *:80&gt;
    ServerName pycsw
    ServerAlias pycsw
    DocumentRoot /var/www/pycsw
    ErrorLog /var/www/pycsw/log/error.log
    CustomLog /var/www/pycsw/log/requests.log combined

    ProxyPass &#34;/csw&#34; &#34;http://127.0.0.1:8000&#34;
    ProxyPassReverse &#34;/csw&#34; &#34;http://127.0.0.1:8000&#34;

    RewriteEngine On
    RewriteCond %{REQUEST_URI} !^\/csw.*$
    RewriteCond %{REQUEST_URI} !^\/glass.*$
    RewriteCond %{REQUEST_URI} !^\/zhangheng.*$
    # RewriteRule Pattern Substitution [Flags]
    # ^ the begining of path
    # - do not substitute
    # response 404 and stop rewriting immediately
    RewriteRule ^ - [R=404,L]
&lt;/VirtualHost&gt;
</code></pre></td></tr></table>
</div>
</div><h4 id="pycsw里defaultcfg">pycsw里default.cfg</h4>
<ul>
<li>关于端口设置<br>
如果用wsgi.py的话，默认就是localhost:8000 在config里面改的端口是pycsw用来给外面描述的（应该写成被apache重定向之后的那个），比如在opensearch的atom返回里面就记录了这个返回xml的URL，URL里面的ip和port就是在config里面改的</li>
<li>关于log<br>
pycsw的log等级我定成了DEBUG，文本较多，希望使用logrotate来管理。logrotate的log目录不能是所有人读写的，因此放在/var/log/pycsw，并且给root新建了一个组pycsw用来处理log。<br>
/etc/logrotate.d/pycsw的内容为：</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">/var/log/pycsw.log{
monthly
minsize 10M
create 0664 root pycsw
rotate 3
missingok
notifempty
dateext
}
</code></pre></td></tr></table>
</div>
</div><h4 id="确保运行">确保运行</h4>
<ul>
<li>发现这个pycsw的wsgi会谜之停止，log上看不出是怎么回事，因此设置了一个脚本放到cron里来检查/csw有没有返回，若没有的话就杀死，然后新开一个screen来跑pycsw。</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="cp">#!/bin/sh
</span><span class="cp"></span><span class="nv">res</span><span class="o">=</span><span class="k">$(</span> curl -w %<span class="o">{</span>http_code<span class="o">}</span> -s --output /dev/null http://localhost:8000/csw<span class="k">)</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$res</span> -ne <span class="m">200</span> <span class="o">]</span>
<span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&#34;Error </span><span class="nv">$res</span><span class="s2"> on </span><span class="nv">$1</span><span class="s2">&#34;</span>
    <span class="c1"># kill existed and start</span>
    <span class="k">if</span> screen -list <span class="p">|</span> grep -q <span class="s2">&#34;pycsw&#34;</span><span class="p">;</span> <span class="k">then</span>
       screen -S pycsw -X quit
    <span class="k">fi</span>
    <span class="c1"># startnew</span>
    screen -S pycsw -dm bash -c <span class="s1">&#39;. /root/pycsw/bin/activate; python /root/pycsw/pycsw-2.6.0/pycsw/wsgi.py&#39;</span>
<span class="k">fi</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="pycsw输出opensearch结果的流程">pycsw输出opensearch结果的流程</h3>
<ul>
<li>发送GET请求，版本为csw2.0.2，请求为getRecords，方式为opensearch</li>
<li>server.py 导入outputSchemas，根据请求设置iface为csw2类并导入KVP parameters，调用csw2的getRecords方法获得符合outputschema的结果，调用response_csw2opensearch得到符合opensearch的返回结果</li>
<li>csw2.py 实现getRecords，根据输入parameters的不同以不同方式生成<a href="ogc:filter" rel="">ogc:filter</a>xml形式的constraints，再转为对数据库的查询语句，使用repository.py的query.all()方法得到结果。得到结果后，调用outputSchema目录中atom.py的write_record方法返回查询到的多条记录</li>
<li>这个query本来是sqlalchemy.session.query定义的类，在repository.py中继承，加了一些方法（如何从kvp解析的条件组装出来类）。它的all方法可以执行查询，返回list。在repository.py里面有LOG指明了查询开始的地方</li>
<li>atom.py 实现write_record方法，把查询到的按照pycsw md_core_model组织的记录转换为本schema定义的xml形式 （atom:entry atom:category atom:id等）</li>
<li>opensearch.py 实现response_csw2opensearch的_csw2_2_os给csw得到的返回记录们加上opensearch要求的头部（atom:feed atom:id atom:title os:totalResults os:startIndex os:itemsPerPage）</li>
<li>pycsw/core/config.py有pycsw的md_core_model  etc/mappings.py里是md_core_model和数据库的对应。</li>
</ul>
<h3 id="对pycsw的修改">对pycsw的修改</h3>
<h4 id="给返回结果加上dcdate和relencolsure">给返回结果加上dc:date和rel=encolsure</h4>
<p>(CWIC Opensearch Best Practice中推荐，对方要求有这个日期值。给rel=enclosure是为了让NASA知道这个是下载链接)</p>
<ul>
<li>在2.6.0版本的pycsw/pycsw/plugins/outputschemas/atom.py加入</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="n">val1</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">getqattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">md_core_model</span><span class="p">[</span><span class="s1">&#39;mappings&#39;</span><span class="p">][</span><span class="s1">&#39;pycsw:TempExtent_begin&#39;</span><span class="p">])</span>
<span class="n">val2</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">getqattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">md_core_model</span><span class="p">[</span><span class="s1">&#39;mappings&#39;</span><span class="p">][</span><span class="s1">&#39;pycsw:TempExtent_end&#39;</span><span class="p">])</span>
<span class="n">date</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span>
<span class="k">if</span> <span class="n">val1</span><span class="p">:</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">val1</span> <span class="o">+</span> <span class="n">date</span>
<span class="k">if</span> <span class="n">val2</span><span class="p">:</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">date</span> <span class="o">+</span> <span class="n">val2</span>
<span class="k">if</span> <span class="p">(</span><span class="n">date</span> <span class="o">!=</span> <span class="s1">&#39;/&#39;</span><span class="p">):</span>
    <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">util</span><span class="o">.</span><span class="n">nspath_eval</span><span class="p">(</span><span class="s1">&#39;dc:date&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">namespaces</span><span class="p">))</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">date</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="通过cql或者filterxml来搜索数据集">通过CQL或者FILTERXML来搜索数据集</h4>
<ul>
<li>上面已经提到了pycsw搜索数据集的流程。如果根据Opensearch的q=collection_id这种方法来限定查询的数据集，速度慢。这是因为q是根据数据库记录全文向量化之后的结果来查询，没有索引。</li>
<li>实验：在csw2.py修改了kvp constraints里面的where语句，直接指定records.parentIdentifire=identifier，发现可以加快速度。这是因为此constraints用于定义repository.py中的query实例。</li>
<li>pycsw的GET请求kvp里面可以设置constraints，以达到过滤的目的，但是文档里没有说怎么加。看代码和测试和issues找到了CQL和Filter XML两种方式，其中CQL方式更方便。由于查询条件是xml中的值，&amp;&lt;&gt;都不能出现，官方的例子是全都URLEncode过之后的结果见https://github.com/geopython/pycsw/blob/master/tests/functionaltests/suites/default/get/requests.txt</li>
<li>使用q和CQL两种方式的具体测试结果在我的本地文件 Tsinghua\组务\2020元数据csw\GLASS-CSW\GLASS-OSDD.xlsx里面有记录</li>
</ul>
<h4 id="同时使用filter和kvp">同时使用Filter和KVP</h4>
<ul>
<li>pycsw2.6.0无法同时处理CQL/XML Filter（此处用来指定Collection）和KVP Constraints（用来指定时间空间），同时输入这两种条件会出现忽略或报错的情况。但显然指定Collection的Opensearch需要同时输入这两种条件，因此要修改csw2.py</li>
<li>pycsw2.8.0可以在kvp里指定parentIdentifier，但同时使用Filter和KVP的问题不知道有没有解决。</li>
<li>csw2.py本来关于Filter的处理逻辑：
<ol>
<li>self.parent.kvp[&lsquo;constraintlanguage&rsquo;]有两种：CQL和Filter</li>
<li>self.parent.kvp[&lsquo;constraint&rsquo;]用来放具体constraint内容</li>
<li>若检测到kvp中有OpenSearch Geo/Time Extension规定的key（<code>self.parent.kvp['bbox/time/q']</code>, 在2.8.0版本中应该有更多？），就设置constraintlanguage为Filter，将此kvp转为xml并作为constraint的内容</li>
<li>若没有检测到上面的几种key，就根据constraintlanguage的类型分别获取到xml,再转为数据库查询</li>
</ol>
</li>
<li>修改后的处理逻辑：
<ol>
<li>检测到OpenSearch Geo/Time Extension规定的key时先判断是否有CQL/XML Constraints已经被定义。</li>
<li>若有，就把这几个key转为xml filter，CQL/XML Constraints转为<a href="ogc:Filter" rel="">ogc:Filter</a>，二者合并。</li>
<li>若没有，设置constraintlanguage为Filter，将此kvp转为xml并作为constraint的内容（和原来一样）</li>
</ol>
</li>
<li>修改已经放到了Github的版本里</li>
</ul>
<h4 id="处理optional-template-parameters">处理Optional Template Parameters</h4>
<ul>
<li>Optional template parameters就是key=?这种，如果没有值可用的话， 搜索客户端就把空值放到?里。CEOS测试数据集时用了这个，需要我们不报错。</li>
<li>在csw2.py中加入判断，kvp中检测到了key但value为空，不要处理，也不要抛出异常终止响应</li>
<li>相应修改已经放到了Github的版本里</li>
</ul>
<h3 id="如何查询">如何查询</h3>
<ul>
<li>gmd:parentId设置成为某注册过的Id之后，使用OpenSearch kvp的q=parentIdentifier（速度慢）或CQL/XML条件（速度快）写死来区分各个collection</li>
<li>POST查询中Envelop的左下角右上角，先经度后纬度，±180和±90，见https://docs.opengeospatial.org/cs/17-002r1/17-002r1.html</li>
<li>NASA要求有r={os:SearchTerms}，作为伪opensearch的任意字段查询，否则解析不了。有没有q影响不大</li>
<li>查询例子（经过了对上述pycsw的修改测试）：见Github<br>
<a href="https://github.com/Theropod/CWIC-OpenSearch/blob/main/csw-requests.md" target="_blank" rel="noopener noreferrer">https://github.com/Theropod/CWIC-OpenSearch/blob/main/csw-requests.md</a></li>
</ul>
<h3 id="程序管理">程序管理</h3>
<h4 id="版本控制">版本控制</h4>
<ul>
<li>生产环境（virtualenv pycsw）放了pycsw-2.6.0，已经同步了所有修改</li>
<li>开发环境（virtualenv pycsw-dev）目前是修改后的2.6.0。这个部分是git管理的，upstream是pycsw，orgin是我fork的pycsw版本，用来同步我的修改。2.8.0的正式版要是出来，就merge之后同步.</li>
</ul>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2021-06-21</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/hugoblog/2021-06-01-%E9%80%82%E7%94%A8%E4%BA%8Ecwic-opensearch%E7%9A%84pycsw%E8%B0%83%E6%95%B4/index.md" target="_blank" rel="noopener noreferrer">Read Markdown</a>
                        </span></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/hugoblog/tags/%E6%AF%95%E4%B8%9A%E7%94%A8/">毕业用</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/hugoblog/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/hugoblog/2021-01-30-%E4%BF%9D%E6%8C%81%E5%AE%9E%E9%AA%8C%E5%AE%A4%E7%BD%91%E7%BB%9C%E8%BF%9E%E6%8E%A5%E5%88%B0%E6%B8%85%E5%8D%8E%E7%BD%91/" class="prev" rel="prev" title="保持实验室电脑连接到清华网"><i class="fas fa-angle-left fa-fw"></i>保持实验室电脑连接到清华网</a>
            <a href="/hugoblog/2021-06-21-fork%E4%B9%8B%E5%90%8E%E8%AE%BE%E7%BD%AEupstream%E5%92%8Corigin%E8%AE%B0%E5%BD%95%E4%BF%AE%E6%94%B9merge%E4%B8%BB%E4%BB%93%E5%BA%93%E5%8F%98%E5%8C%96/" class="next" rel="next" title="Fork之后设置upstream和origin记录修改、merge主仓库变化">Fork之后设置upstream和origin记录修改、merge主仓库变化<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreferrer" title="Hugo 0.92.2">Hugo</a> | Theme - <a href="https://github.com/sunt-programator/CodeIT" target="_blank" rel="noopener noreferrer" title="CodeIT 0.2.10"><i class="fas fa-laptop-code fa-fw"></i> CodeIT</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2019 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://blog.theropod.tk" target="_blank" rel="noopener noreferrer">WGS84教信者</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/hugoblog/lib/lightgallery/lightgallery.min.814eba54011def7fdeead06ae5cf964a245c347d0f4972e71cc3de1482b1b473.css" integrity="sha256-gU66VAEd73/e6tBq5c&#43;WSiRcNH0PSXLnHMPeFIKxtHM="><script type="text/javascript" src="/hugoblog/lib/smooth-scroll/smooth-scroll.min.bcff85fb5e00d68802850b393ac7792c997f722f536f38e26638c46dca8e5eb6.js" integrity="sha256-vP&#43;F&#43;14A1ogChQs5Osd5LJl/ci9TbzjiZjjEbcqOXrY="></script><script type="text/javascript" src="/hugoblog/lib/lazysizes/lazysizes.min.fb649fcae62177dfe63e67081ddceb830b5ce1f05a4184e9bbb7d87ac4b8f4e5.js" integrity="sha256-&#43;2SfyuYhd9/mPmcIHdzrgwtc4fBaQYTpu7fYesS49OU="></script><script type="text/javascript" src="/hugoblog/lib/lightgallery/lightgallery.min.0ef47b3aa47d71accebfc4c7029c37f43d35f3ef43cda0e706c7adb8851f9554.js" integrity="sha256-DvR7OqR9cazOv8THApw39D018&#43;9DzaDnBsetuIUflVQ="></script><script type="text/javascript" src="/hugoblog/lib/lightgallery/lg-thumbnail.min.87bd0bf4ede9af1be2287acf1f0ac8777dc76a49209d44620752811c3c993897.js" integrity="sha256-h70L9O3prxviKHrPHwrId33HakkgnURiB1KBHDyZOJc="></script><script type="text/javascript" src="/hugoblog/lib/lightgallery/lg-zoom.min.5993efde07d6b1a88dd5d5ff00cf5c0178d1d8c7f682eae59546a8e144aac57e.js" integrity="sha256-WZPv3gfWsaiN1dX/AM9cAXjR2Mf2gurllUao4USqxX4="></script><script type="text/javascript" src="/hugoblog/lib/clipboard/clipboard.min.8a7739925f4c03586479852df840b7061948832a7fda30c8c812d2ea4dd4c4f2.js" integrity="sha256-inc5kl9MA1hkeYUt&#43;EC3BhlIgyp/2jDIyBLS6k3UxPI="></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":10},"comment":{},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true}};</script><script type="text/javascript" src="/hugoblog/js/theme.min.47a1ff73dc443ed4a9f13e3134f6058e8c6d21248b35d03e7d64f56345190c3e.js" integrity="sha256-R6H/c9xEPtSp8T4xNPYFjoxtISSLNdA&#43;fWT1Y0UZDD4="></script></body>
</html>
